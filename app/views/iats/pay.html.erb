<html>
  <head>
    <script
      src="https://code.jquery.com/jquery-3.3.1.min.js"
      integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
      crossorigin="anonymous"></script>
    <script 
      src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0/js/bootstrap.bundle.min.js"
      integrity="sha256-uz0BcnPtSHZ02XZthAHPRYIoWWrcwMOmAk9ErnFQkNs="
      crossorigin="anonymous"></script>
    <link 
      rel="stylesheet" 
      href="https://use.fontawesome.com/releases/v5.0.9/css/all.css" 
      integrity="sha384-5SOiIsAziJl6AWe0HWRKTXlfcSHKmYV4RBF18PPJ173Kzn7jzMyFuTtk8JA7QQG1" 
      crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet">
    <style>
      body {
        margin: 0;
      }
      .form-group {
        position: relative;
      }
      .form-group.half-width {
        width: calc(50% - 10px);
        display: inline-block;
      }
      .form-group.two-third {
        width: calc(66% - 6px);
        display: inline-block;
      }
      .form-group.one-third {
        width: calc(33% - 10px);
        display: inline-block;
      }
      @media only screen and (max-width: 450px) {
        .form-group.half-width {
          width: 100%;
          display: inline-block;
        }
        #transit-number {
          margin-left: 0px !important;
        }
        #transit-number + label {
          padding-left: 0px !important;
        }
      }
      .card-info {
    		height: 2.5rem;
    		position: relative;
        margin-top: 16px;
    		width: 100%;
        padding-left: 17px;
    		outline: 0;
        border-radius: 4px;
        border: 0;
    		font-weight: 700;
        font-size: 14px;
        color: #555;
        font-family: 'Montserrat';
    	}
      #transit-number {
        margin-left: 16px;
        padding-left: 17px;
      }
      #transit-number + label {
        padding-left: 17px;
      }
      .card-info:focus {
    		-webkit-box-shadow: none;
    		-moz-box-shadow: none;
    		box-shadow: none;
    	}
      .placeholder-label {
    		cursor: text;
    	  position: absolute;
    	  left: 15px;
    	  top: 26px;
    	  color: #555;
    	  z-index: 10;
        line-height: 28px;
    	  transition: transform 150ms ease-out, font-size 150ms ease-out;
        font-family: 'Montserrat';
        font-weight: 700;
        font-size: 14px;
    	}
      .focused .placeholder-label {
        transform: translateY(-64%);
        font-size: .55em;
        color: #39b098;
      }
      .placeholder-label > i {
        cursor: pointer;
      }
      .focused .placeholder-label > i {
        display: none;
      }
      .popover {
        position: absolute;
      }
      .select {
        margin-left: 16px;
        background: #fff;
        height: 2.5rem;
        width: 100%;
        outline: 0;
        border: 0;
        transition: box-shadow 150ms ease-out;
        font-weight: 700;
        font-size: 14px;
        line-height: 28px;
        font-family: 'Montserrat';
        color: #555;
      }
      #account-image {
        display: none;
      }
      .popover {
        z-index: 10;
        margin-left: 20px;
        margin-top: 90px;
        max-width: 400px;
      }
    </style>
  </head>
  <body>
    <div class="payment-form" id="payment">
      <form>
        <div class="row">
          <div class="form-group two-third">
            <label for="account-number" class="placeholder-label">
              Account Number <i data-toggle="popover" class="far fa-question-circle" id="account-icon"></i>
            </label>
            <input type="text" class="card-info" id="account-number"</input>
          </div>
          <div class="form-group one-third">
            <select class="select" id="account-type">
              <option value="CHECKING">Chequing</option>
              <option value="SAVING">Savings</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div class="form-group half-width">
            <label for="bank-number" class="placeholder-label">
              Bank Number <i data-toggle="popover" class="far fa-question-circle" id="bank-icon"></i>
            </label>
            <input type="text" class="card-info" id="bank-number"></input>
          </div>
          <div class="form-group half-width">
            <input type="text" class="card-info" id="transit-number"></input>
            <label for="Transit Number" class="placeholder-label">
              Transit Number <i data-toggle="popover" class="far fa-question-circle" id="transit-icon"></i>
            </label>
          </div>
        </div>

        <div id="card-errors" role="alert"></div>
      </form>
    </div>



    <script>
      function saveTokenAndChargeCard(metadata, source, amount, recurring, date) {
        var url = '<%= "#{pay_url(@processor)}?key=#{@api_user.key}" %>';
        var data = JSON.stringify({
          metadata: metadata,
          source: source,
          amount: amount,
          recurring: recurring,
          date: date
        });
        
        var request = new XMLHttpRequest();

        request.open('POST', url, true);
        request.setRequestHeader('Content-Type', 'application/json');

        request.onload = function() {
          if (request.status === 200) {
            data = {
              action: "donationProcessed",
              response: JSON.parse(request.responseText)
            };
            parent.postMessage(data, "*");
          } else {
            console.log(request);
          }
        };

        request.onerror = function() {
          console.log('error 2');
        }

        request.send(data);
      }
      
      var button = $('#submit');
      var bankNumber = $('#bank-number');
      var accountNumber = $('#account-number');
      var transitNumber = $('#transit-number');
      var accountType = $('#account-type');
      
      $(".card-info").focus(function() {
        $(this).parents('.form-group').addClass('focused');
      });

      $(".card-info").blur(function() {
        var inputValue = $(this).val();
        if ( inputValue == "" ) {
          $(this).parents('.form-group').removeClass('focused');
        }
      });
      
      $(".placeholder-label").on("click",function(){
        $(this).siblings().focus();
      });

      $('#account-icon').popover({
        trigger: 'hover',
        container: 'body',
        html: true,
        content: '<img src="https://s3.amazonaws.com/leadnow-identity/uploads/cheque-account.jpg" style="width:100%"/>'
      });
      
      $('#bank-icon').popover({
        trigger: 'hover',
        container: 'body',
        html: true,
        content: '<img src="https://s3.amazonaws.com/leadnow-identity/uploads/cheque-bank.jpg" style="width:100%"/>'
      });
      
      $('#transit-icon').popover({
        trigger: 'hover',
        container: 'body',
        html: true,
        content: '<img src="https://s3.amazonaws.com/leadnow-identity/uploads/cheque-transit.jpg" style="width:100%"/>'
      });
      
      window.addEventListener("message", function(event) {
        var data = event.data;
        if (data.action === "submit") {
          var accountNum = bankNumber.val() + transitNumber.val() + accountNumber.val();
          data.metadata["account_number"] = accountNum;
          data.metadata["account_type"] = accountType.val();
          saveTokenAndChargeCard(data.metadata, data.source, data.donationAmount, data.recurring, data.date);
        }
      }, false);
    </script>
  </body>
</html>
